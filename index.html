<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>TiltHarmonica - ã‚¹ãƒãƒ›å‚¾ããƒãƒ¼ãƒ¢ãƒ‹ã‚«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .nav-button {
            padding: 10px 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            backdrop-filter: blur(10px);
        }

        .nav-button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .nav-button.active {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.8);
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.2);
        }

        .explanation-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .explanation-section h2 {
            color: #4a5568;
            margin-bottom: 15px;
            font-size: 1.4rem;
        }

        .explanation-section h3 {
            color: #2d3748;
            margin: 20px 0 10px 0;
            font-size: 1.2rem;
        }

        .explanation-section p {
            margin-bottom: 10px;
            color: #2d3748;
        }

        .explanation-section ul {
            margin-left: 20px;
            margin-bottom: 15px;
        }

        .explanation-section li {
            margin-bottom: 5px;
            color: #2d3748;
        }

        .code-block {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
        }

        .status-section,
        .control-section,
        .instruction-section,
        .action-section,
        .sensor-section {
            margin-bottom: 25px;
        }

        .status-card,
        .control-card,
        .instruction-card,
        .sensor-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .status-card h3,
        .control-card h3,
        .instruction-card h3,
        .sensor-card h3 {
            margin-bottom: 15px;
            color: #4a5568;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-text {
            font-weight: 500;
            color: #2d3748;
        }

        .status-indicator.ready .status-text {
            color: #38a169;
        }

        .status-indicator.error .status-text {
            color: #e53e3e;
        }

        .info-grid {
            display: grid;
            gap: 12px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .label {
            font-weight: 500;
            color: #4a5568;
        }

        .value {
            font-weight: 600;
            color: #2d3748;
            font-family: 'Courier New', monospace;
        }

        .instructions {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .instruction-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: #f7fafc;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .instruction-item .icon {
            font-size: 1.5rem;
            min-width: 30px;
        }

        .instruction-item .text {
            font-weight: 500;
            color: #2d3748;
        }

        .start-button {
            width: 100%;
            padding: 18px;
            font-size: 1.3rem;
            font-weight: 600;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            margin-bottom: 15px;
        }

        .start-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .start-button:active {
            transform: translateY(0);
        }

        .start-button.playing {
            background: linear-gradient(45deg, #e53e3e, #c53030);
            box-shadow: 0 4px 15px rgba(229, 62, 62, 0.4);
        }

        .permission-notice {
            text-align: center;
            color: #e53e3e;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .sensor-grid {
            display: grid;
            gap: 10px;
        }

        .sensor-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }

        .sensor-label {
            font-weight: 500;
            color: #4a5568;
        }

        .sensor-value {
            font-weight: 600;
            color: #2d3748;
            font-family: 'Courier New', monospace;
            background: #f7fafc;
            padding: 4px 8px;
            border-radius: 4px;
            min-width: 60px;
            text-align: center;
        }

        .warning-box {
            background: #fed7d7;
            border: 1px solid #feb2b2;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            color: #c53030;
        }

        .info-box {
            background: #bee3f8;
            border: 1px solid #90cdf4;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            color: #2b6cb0;
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            header h1 {
                font-size: 2rem;
            }
            
            .subtitle {
                font-size: 1rem;
            }
            
            .status-card,
            .control-card,
            .instruction-card,
            .sensor-card,
            .explanation-section {
                padding: 15px;
            }
            
            .start-button {
                padding: 15px;
                font-size: 1.2rem;
            }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .playing .start-button {
            animation: pulse 2s infinite;
        }

        @media (prefers-color-scheme: dark) {
            body {
                background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            }
            
            .status-card,
            .control-card,
            .instruction-card,
            .sensor-card,
            .explanation-section {
                background: rgba(45, 55, 72, 0.95);
                color: #e2e8f0;
            }
            
            .status-card h3,
            .control-card h3,
            .instruction-card h3,
            .sensor-card h3,
            .explanation-section h2,
            .explanation-section h3 {
                color: #e2e8f0;
            }
            
            .label,
            .sensor-label {
                color: #a0aec0;
            }
            
            .value,
            .sensor-value {
                color: #e2e8f0;
            }
            
            .instruction-item {
                background: #2d3748;
                color: #e2e8f0;
            }
            
            .sensor-value {
                background: #4a5568;
            }
            
            .code-block {
                background: #2d3748;
                color: #e2e8f0;
                border-color: #4a5568;
            }
            
            .explanation-section p,
            .explanation-section li {
                color: #e2e8f0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸµ TiltHarmonica</h1>
            <p class="subtitle">ã‚¹ãƒãƒ›ã‚’å‚¾ã‘ã¦æ¼”å¥ã—ã‚ˆã†ï¼</p>
            <div class="nav-buttons">
                <button id="nav-main" class="nav-button active">ğŸ¼ ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª</button>
                <button id="nav-test" class="nav-button">ğŸ§ª ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸</button>
            </div>
        </header>

        <!-- å‹•ä½œèª¬æ˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="explanation-section">
            <h2>ğŸ“– ã‚¢ãƒ—ãƒªã®å‹•ä½œã«ã¤ã„ã¦</h2>
            
            <h3>ğŸ¯ ã‚¢ãƒ—ãƒªã®ç›®çš„</h3>
            <p>ã“ã®ã‚¢ãƒ—ãƒªã¯ã€ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã®å‚¾ãã‚»ãƒ³ã‚µãƒ¼ï¼ˆã‚¸ãƒ£ã‚¤ãƒ­ãƒ»åŠ é€Ÿåº¦ã‚»ãƒ³ã‚µãƒ¼ï¼‰ã‚’ä½¿ã£ã¦ã€ç›´æ„Ÿçš„ã«éŸ³éšã¨éŸ³é‡ã‚’æ“ä½œã—ã¦æ¼”å¥ä½“é¨“ã‚’æä¾›ã—ã¾ã™ã€‚</p>
            
            <h3>ğŸ”§ æŠ€è¡“çš„ãªä»•çµ„ã¿</h3>
            <p><strong>ä½¿ç”¨ã—ã¦ã„ã‚‹æŠ€è¡“:</strong></p>
            <ul>
                <li><strong>Web Audio API</strong>: ãƒ–ãƒ©ã‚¦ã‚¶ã§éŸ³å£°ã‚’ç”Ÿæˆãƒ»åˆ¶å¾¡</li>
                <li><strong>DeviceOrientationEvent</strong>: ã‚¹ãƒãƒ›ã®å‚¾ãã‚’æ¤œçŸ¥</li>
                <li><strong>HTML5/CSS3</strong>: ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãªUI</li>
                <li><strong>JavaScript ES6+</strong>: ãƒ¢ãƒ€ãƒ³ãªãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°</li>
            </ul>

            <h3>ğŸ“± ã‚»ãƒ³ã‚µãƒ¼ã®å‹•ä½œåŸç†</h3>
            <p>ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã«ã¯ä»¥ä¸‹ã®ã‚»ãƒ³ã‚µãƒ¼ãŒæ­è¼‰ã•ã‚Œã¦ã„ã¾ã™ï¼š</p>
            <ul>
                <li><strong>Gammaè»¸ï¼ˆå·¦å³å‚¾ãï¼‰</strong>: ã‚¹ãƒãƒ›ã‚’å·¦å³ã«å‚¾ã‘ã‚‹ã¨éŸ³éšãŒå¤‰ã‚ã‚Šã¾ã™</li>
                <li><strong>Betaè»¸ï¼ˆå‰å¾Œå‚¾ãï¼‰</strong>: ã‚¹ãƒãƒ›ã‚’å‰å¾Œã«å‚¾ã‘ã‚‹ã¨éŸ³é‡ãŒå¤‰ã‚ã‚Šã¾ã™</li>
            </ul>

            <h3>ğŸ¼ éŸ³éšã®ä»•çµ„ã¿</h3>
            <p>éŸ³éšã¯ä»¥ä¸‹ã®ã‚ˆã†ã«åˆ¶å¾¡ã•ã‚Œã¾ã™ï¼š</p>
            <div class="code-block">
éŸ³éšç¯„å›²: C4 (261.63Hz) ã€œ C5 (523.25Hz)
å·¦å³å‚¾ã: -45Â° ã€œ +45Â° â†’ éŸ³éšã«å¤‰æ›
å‰å¾Œå‚¾ã: -30Â° ã€œ +30Â° â†’ éŸ³é‡ã«å¤‰æ›ï¼ˆ0ã€œ80%ï¼‰
            </div>

            <h3>âš ï¸ é‡è¦ãªæ³¨æ„äº‹é …</h3>
            <div class="warning-box">
                <strong>éŸ³ãŒå‡ºã‚‹ã‚¢ãƒ—ãƒªã§ã™ï¼</strong><br>
                â€¢ å‘¨å›²ã®ç’°å¢ƒã«ã”é…æ…®ãã ã•ã„<br>
                â€¢ ã‚¤ãƒ¤ãƒ›ãƒ³ä½¿ç”¨ã‚’æ¨å¥¨ã—ã¾ã™<br>
                â€¢ é™ã‹ãªå ´æ‰€ã§ãŠæ¥½ã—ã¿ãã ã•ã„
            </div>

            <h3>ğŸ“‹ å¯¾å¿œãƒ‡ãƒã‚¤ã‚¹</h3>
            <div class="info-box">
                <strong>æ¨å¥¨:</strong> iOS Safariã€Android Chrome<br>
                <strong>åˆ¶é™:</strong> PCãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ã‚»ãƒ³ã‚µãƒ¼ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“<br>
                <strong>ãƒ†ã‚¹ãƒˆ:</strong> PCã§ã¯ãƒã‚¦ã‚¹ç§»å‹•ã§ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆå¯èƒ½
            </div>

            <h3>ğŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±</h3>
            <p>ãƒ–ãƒ©ã‚¦ã‚¶ã®é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ï¼ˆF12ï¼‰ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ä»¥ä¸‹ã®æƒ…å ±ãŒç¢ºèªã§ãã¾ã™ï¼š</p>
            <ul>
                <li>ã‚»ãƒ³ã‚µãƒ¼å€¤ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º</li>
                <li>ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</li>
                <li>éŸ³å£°å‡¦ç†ã®çŠ¶æ…‹</li>
            </ul>
        </div>

        <!-- ã‚¢ãƒ—ãƒªæœ¬ä½“ -->
        <div class="status-section">
            <div class="status-card">
                <h3>ğŸ“± ãƒ‡ãƒã‚¤ã‚¹çŠ¶æ…‹</h3>
                <div id="device-status" class="status-indicator">
                    <span class="status-text">ã‚»ãƒ³ã‚µãƒ¼ã‚’ç¢ºèªä¸­...</span>
                </div>
            </div>
        </div>

        <div class="control-section">
            <div class="control-card">
                <h3>ğŸ¼ éŸ³éšãƒ»éŸ³é‡</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="label">éŸ³éš:</span>
                        <span id="note-display" class="value">--</span>
                    </div>
                    <div class="info-item">
                        <span class="label">å‘¨æ³¢æ•°:</span>
                        <span id="frequency-display" class="value">-- Hz</span>
                    </div>
                    <div class="info-item">
                        <span class="label">éŸ³é‡:</span>
                        <span id="volume-display" class="value">--</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="instruction-section">
            <div class="instruction-card">
                <h3>ğŸ® æ“ä½œæ–¹æ³•</h3>
                <div class="instructions">
                    <div class="instruction-item">
                        <span class="icon">â†”ï¸</span>
                        <span class="text">å·¦å³ã«å‚¾ã‘ã‚‹ â†’ éŸ³éšãŒå¤‰ã‚ã‚Šã¾ã™</span>
                    </div>
                    <div class="instruction-item">
                        <span class="icon">â†•ï¸</span>
                        <span class="text">å‰å¾Œã«å‚¾ã‘ã‚‹ â†’ éŸ³é‡ãŒå¤‰ã‚ã‚Šã¾ã™</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="action-section">
            <button id="start-button" class="start-button">
                ğŸµ æ¼”å¥é–‹å§‹
            </button>
            <button id="test-sound-button" class="start-button" style="background: linear-gradient(45deg, #38a169, #2f855a); margin-top: 10px;">
                ğŸ”Š éŸ³å£°ãƒ†ã‚¹ãƒˆ
            </button>
            <button id="permission-button" class="start-button" style="background: linear-gradient(45deg, #ed8936, #dd6b20); margin-top: 10px;">
                ğŸ” ã‚»ãƒ³ã‚µãƒ¼è¨±å¯è¦æ±‚
            </button>
            <div id="permission-notice" class="permission-notice">
                <p>âš ï¸ éŸ³ãŒå‡ºã‚‹ã®ã§å‘¨å›²ã«ã”é…æ…®ãã ã•ã„</p>
            </div>
        </div>

        <div class="sensor-section">
            <div class="sensor-card">
                <h3>ğŸ“Š ã‚»ãƒ³ã‚µãƒ¼å€¤</h3>
                <div class="sensor-grid">
                    <div class="sensor-item">
                        <span class="sensor-label">Gamma (å·¦å³):</span>
                        <span id="gamma-value" class="sensor-value">--Â°</span>
                    </div>
                    <div class="sensor-item">
                        <span class="sensor-label">Beta (ä¸Šä¸‹):</span>
                        <span id="beta-value" class="sensor-value">--Â°</span>
                    </div>
                    <div class="sensor-item">
                        <span class="sensor-label">Alpha (å›è»¢):</span>
                        <span id="alpha-value" class="sensor-value">--Â°</span>
                    </div>
                </div>
                <div style="margin-top: 15px; padding: 10px; background: #f7fafc; border-radius: 8px; font-size: 0.9rem;">
                    <div><strong>ã‚»ãƒ³ã‚µãƒ¼çŠ¶æ…‹:</strong> <span id="sensor-status">ç¢ºèªä¸­...</span></div>
                    <div><strong>ã‚¤ãƒ™ãƒ³ãƒˆå—ä¿¡:</strong> <span id="event-status">ãªã—</span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div id="test-content" class="container" style="display: none;">
        <div class="explanation-section">
            <h2>ğŸ§ª TiltHarmonica ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸</h2>
            <p>ã“ã®ãƒšãƒ¼ã‚¸ã¯ã€GitHub PagesãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã®ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ã§ã™ã€‚</p>
            
            <div class="info-box">
                <h3>âœ… å‹•ä½œç¢ºèªé …ç›®</h3>
                <ul>
                    <li>GitHub Pagesã®è¡¨ç¤º</li>
                    <li>HTML/CSSã®èª­ã¿è¾¼ã¿</li>
                    <li>JavaScriptã®å®Ÿè¡Œ</li>
                    <li>ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³</li>
                </ul>
            </div>
            
            <div class="warning-box">
                <h3>ğŸ“± ãƒ¢ãƒã‚¤ãƒ«ãƒ†ã‚¹ãƒˆ</h3>
                <p>ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã§ã“ã®ãƒšãƒ¼ã‚¸ãŒæ­£å¸¸ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚Œã°ã€ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚‚å‹•ä½œã™ã‚‹ã¯ãšã§ã™ã€‚</p>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <h3>ğŸµ ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã«æˆ»ã‚‹</h3>
                <p>ä¸Šè¨˜ã®ã€ŒğŸ¼ ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã€ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã€TiltHarmonicaã‚’ãŠæ¥½ã—ã¿ãã ã•ã„ï¼</p>
            </div>
        </div>
    </div>

    <script>
        class TiltHarmonica {
            constructor() {
                this.audioContext = null;
                this.oscillator = null;
                this.gainNode = null;
                this.isPlaying = false;
                this.isInitialized = false;
                
                // éŸ³éšè¨­å®šï¼ˆC4ã€œC5ï¼‰
                this.notes = {
                    'C4': 261.63, 'C#4': 277.18, 'D4': 293.66, 'D#4': 311.13,
                    'E4': 329.63, 'F4': 349.23, 'F#4': 369.99, 'G4': 392.00,
                    'G#4': 415.30, 'A4': 440.00, 'A#4': 466.16, 'B4': 493.88,
                    'C5': 523.25
                };
                
                this.noteNames = Object.keys(this.notes);
                
                // ã‚»ãƒ³ã‚µãƒ¼å€¤ã®ç¯„å›²è¨­å®š
                this.gammaRange = { min: -45, max: 45 }; // å·¦å³å‚¾ã
                this.betaRange = { min: -30, max: 30 };  // å‰å¾Œå‚¾ã
                
                this.init();
            }
            
            async init() {
                this.updateDeviceStatus('åˆæœŸåŒ–ä¸­...', 'loading');
                
                try {
                    // Web Audio APIåˆæœŸåŒ–
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    // ã‚»ãƒ³ã‚µãƒ¼ã‚µãƒãƒ¼ãƒˆç¢ºèª
                    if (!window.DeviceOrientationEvent) {
                        throw new Error('ãƒ‡ãƒã‚¤ã‚¹ã‚»ãƒ³ã‚µãƒ¼ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    }
                    
                    // ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ç¢ºèª
                    this.checkSensorPermission();
                    
                    this.updateDeviceStatus('æº–å‚™å®Œäº†ï¼ã‚¿ãƒƒãƒ—ã—ã¦é–‹å§‹', 'ready');
                    this.isInitialized = true;
                    
                } catch (error) {
                    console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                    this.updateDeviceStatus('ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                }
            }
            
            // ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ç¢ºèª
            async checkSensorPermission() {
                try {
                    // ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ã‚’è¦æ±‚
                    if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                        const permission = await DeviceOrientationEvent.requestPermission();
                        if (permission === 'granted') {
                            this.updateSensorStatus('è¨±å¯æ¸ˆã¿');
                            console.log('ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ãŒæ‰¿èªã•ã‚Œã¾ã—ãŸ');
                        } else {
                            this.updateSensorStatus('æ‹’å¦ã•ã‚Œã¾ã—ãŸ');
                            console.log('ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ');
                        }
                    } else {
                        this.updateSensorStatus('è¨±å¯ä¸è¦ï¼ˆè‡ªå‹•è¨±å¯ï¼‰');
                        console.log('ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ã¯è‡ªå‹•çš„ã«è¨±å¯ã•ã‚Œã¦ã„ã¾ã™');
                    }
                } catch (error) {
                    this.updateSensorStatus('ã‚¨ãƒ©ãƒ¼: ' + error.message);
                    console.error('ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ã‚¨ãƒ©ãƒ¼:', error);
                }
            }
            
            updateSensorStatus(status) {
                const statusElement = document.getElementById('sensor-status');
                if (statusElement) {
                    statusElement.textContent = status;
                }
            }
            
            updateDeviceStatus(message, status) {
                const statusElement = document.getElementById('device-status');
                const statusText = statusElement.querySelector('.status-text');
                
                statusText.textContent = message;
                statusElement.className = `status-indicator ${status}`;
            }
            
            startAudio() {
                if (!this.audioContext || this.isPlaying) return;
                
                try {
                    // AudioContextã‚’resumeï¼ˆiOSå¯¾å¿œï¼‰
                    if (this.audioContext.state === 'suspended') {
                        this.audioContext.resume();
                    }
                    
                    // ã‚ªã‚·ãƒ¬ãƒ¼ã‚¿ãƒ¼ä½œæˆ
                    this.oscillator = this.audioContext.createOscillator();
                    this.gainNode = this.audioContext.createGain();
                    
                    // åˆæœŸè¨­å®š
                    this.oscillator.type = 'sine';
                    this.oscillator.frequency.setValueAtTime(440, this.audioContext.currentTime); // A4
                    this.gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                    
                    // æ¥ç¶š
                    this.oscillator.connect(this.gainNode);
                    this.gainNode.connect(this.audioContext.destination);
                    
                    // é–‹å§‹
                    this.oscillator.start();
                    this.isPlaying = true;
                    
                    // ã‚»ãƒ³ã‚µãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆé–‹å§‹
                    this.startSensorEvents();
                    
                    // UIæ›´æ–°
                    this.updateStartButton(true);
                    this.updateDeviceStatus('æ¼”å¥ä¸­...', 'ready');
                    
                } catch (error) {
                    console.error('éŸ³å£°é–‹å§‹ã‚¨ãƒ©ãƒ¼:', error);
                    this.updateDeviceStatus('éŸ³å£°ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                }
            }
            
            stopAudio() {
                if (!this.isPlaying) return;
                
                try {
                    // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
                    this.gainNode.gain.setValueAtTime(this.gainNode.gain.value, this.audioContext.currentTime);
                    this.gainNode.gain.linearRampToValueAtTime(0, this.audioContext.currentTime + 0.1);
                    
                    setTimeout(() => {
                        if (this.oscillator) {
                            this.oscillator.stop();
                            this.oscillator = null;
                        }
                        this.gainNode = null;
                        this.isPlaying = false;
                        
                        // ã‚»ãƒ³ã‚µãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆåœæ­¢
                        this.stopSensorEvents();
                        
                        // UIæ›´æ–°
                        this.updateStartButton(false);
                        this.updateDeviceStatus('æº–å‚™å®Œäº†ï¼ã‚¿ãƒƒãƒ—ã—ã¦é–‹å§‹', 'ready');
                    }, 100);
                    
                } catch (error) {
                    console.error('éŸ³å£°åœæ­¢ã‚¨ãƒ©ãƒ¼:', error);
                }
            }
            
            startSensorEvents() {
                window.addEventListener('deviceorientation', this.handleOrientation.bind(this));
                console.log('ã‚»ãƒ³ã‚µãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’é–‹å§‹ã—ã¾ã—ãŸ');
                this.updateEventStatus('ãƒªã‚¹ãƒŠãƒ¼é–‹å§‹');
            }
            
            stopSensorEvents() {
                window.removeEventListener('deviceorientation', this.handleOrientation.bind(this));
                console.log('ã‚»ãƒ³ã‚µãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’åœæ­¢ã—ã¾ã—ãŸ');
                this.updateEventStatus('åœæ­¢ä¸­');
            }
            
            handleOrientation(event) {
                if (!this.isPlaying || !this.oscillator || !this.gainNode) return;
                
                const gamma = event.gamma; // å·¦å³å‚¾ã (-180 to 180)
                const beta = event.beta;   // å‰å¾Œå‚¾ã (-180 to 180)
                const alpha = event.alpha; // å›è»¢ (-180 to 180)
                
                // ã‚»ãƒ³ã‚µãƒ¼å€¤è¡¨ç¤ºæ›´æ–°
                this.updateSensorDisplay(gamma, beta, alpha);
                
                // ã‚¤ãƒ™ãƒ³ãƒˆå—ä¿¡çŠ¶æ…‹æ›´æ–°
                this.updateEventStatus('å—ä¿¡ä¸­');
                
                // éŸ³éšè¨ˆç®—ï¼ˆgammaä½¿ç”¨ï¼‰
                const frequency = this.calculateFrequency(gamma);
                const noteName = this.getNoteName(frequency);
                
                // éŸ³é‡è¨ˆç®—ï¼ˆbetaä½¿ç”¨ï¼‰
                const volume = this.calculateVolume(beta);
                
                // éŸ³å£°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ›´æ–°
                this.updateAudioParameters(frequency, volume);
                
                // UIæ›´æ–°
                this.updateDisplay(noteName, frequency, volume);
            }
            
            calculateFrequency(gamma) {
                // gammaã‚’éŸ³éšç¯„å›²ã«ãƒãƒƒãƒ”ãƒ³ã‚°
                const clampedGamma = Math.max(this.gammaRange.min, Math.min(this.gammaRange.max, gamma));
                const normalizedGamma = (clampedGamma - this.gammaRange.min) / (this.gammaRange.max - this.gammaRange.min);
                
                // å‘¨æ³¢æ•°ç¯„å›²: C4 (261.63Hz) ã€œ C5 (523.25Hz)
                const minFreq = 261.63;
                const maxFreq = 523.25;
                
                return minFreq + (maxFreq - minFreq) * normalizedGamma;
            }
            
            calculateVolume(beta) {
                // betaã‚’éŸ³é‡ç¯„å›²ã«ãƒãƒƒãƒ”ãƒ³ã‚°
                const clampedBeta = Math.max(this.betaRange.min, Math.min(this.betaRange.max, beta));
                const normalizedBeta = (clampedBeta - this.betaRange.min) / (this.betaRange.max - this.betaRange.min);
                
                // éŸ³é‡ç¯„å›²: 0 ã€œ 0.8ï¼ˆæœ€å¤§éŸ³é‡ã¯å°‘ã—æŠ‘ãˆã‚‹ï¼‰
                return Math.max(0, Math.min(0.8, normalizedBeta));
            }
            
            getNoteName(frequency) {
                // æœ€ã‚‚è¿‘ã„éŸ³éšã‚’æ¢ã™
                let closestNote = 'C4';
                let minDifference = Infinity;
                
                for (const [noteName, noteFreq] of Object.entries(this.notes)) {
                    const difference = Math.abs(frequency - noteFreq);
                    if (difference < minDifference) {
                        minDifference = difference;
                        closestNote = noteName;
                    }
                }
                
                return closestNote;
            }
            
            updateAudioParameters(frequency, volume) {
                if (!this.oscillator || !this.gainNode) return;
                
                const currentTime = this.audioContext.currentTime;
                
                // å‘¨æ³¢æ•°ã‚’æ»‘ã‚‰ã‹ã«å¤‰æ›´
                this.oscillator.frequency.setValueAtTime(frequency, currentTime);
                
                // éŸ³é‡ã‚’æ»‘ã‚‰ã‹ã«å¤‰æ›´
                this.gainNode.gain.setValueAtTime(volume, currentTime);
            }
            
            updateDisplay(noteName, frequency, volume) {
                // éŸ³éšè¡¨ç¤º
                document.getElementById('note-display').textContent = noteName;
                
                // å‘¨æ³¢æ•°è¡¨ç¤º
                document.getElementById('frequency-display').textContent = `${Math.round(frequency)} Hz`;
                
                // éŸ³é‡è¡¨ç¤ºï¼ˆãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ï¼‰
                const volumePercent = Math.round(volume * 100);
                document.getElementById('volume-display').textContent = `${volumePercent}%`;
            }
            
            updateSensorDisplay(gamma, beta, alpha) {
                // ã‚»ãƒ³ã‚µãƒ¼å€¤è¡¨ç¤º
                document.getElementById('gamma-value').textContent = `${Math.round(gamma)}Â°`;
                document.getElementById('beta-value').textContent = `${Math.round(beta)}Â°`;
                document.getElementById('alpha-value').textContent = `${Math.round(alpha)}Â°`;
            }
            
            updateStartButton(isPlaying) {
                const button = document.getElementById('start-button');
                if (isPlaying) {
                    button.textContent = 'â¹ï¸ æ¼”å¥åœæ­¢';
                    button.classList.add('playing');
                } else {
                    button.textContent = 'ğŸµ æ¼”å¥é–‹å§‹';
                    button.classList.remove('playing');
                }
            }
            
            updateEventStatus(status) {
                const eventElement = document.getElementById('event-status');
                if (eventElement) {
                    eventElement.textContent = status;
                }
            }
            
            // éŸ³å£°ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½
            testSound() {
                if (!this.audioContext) {
                    alert('éŸ³å£°ã‚·ã‚¹ãƒ†ãƒ ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    return;
                }
                
                try {
                    // AudioContextã‚’resumeï¼ˆiOSå¯¾å¿œï¼‰
                    if (this.audioContext.state === 'suspended') {
                        this.audioContext.resume();
                    }
                    
                    // ãƒ†ã‚¹ãƒˆç”¨ã‚ªã‚·ãƒ¬ãƒ¼ã‚¿ãƒ¼ä½œæˆ
                    const testOsc = this.audioContext.createOscillator();
                    const testGain = this.audioContext.createGain();
                    
                    // è¨­å®š
                    testOsc.type = 'sine';
                    testOsc.frequency.setValueAtTime(440, this.audioContext.currentTime); // A4
                    testGain.gain.setValueAtTime(0.3, this.audioContext.currentTime); // é©åº¦ãªéŸ³é‡
                    
                    // æ¥ç¶š
                    testOsc.connect(testGain);
                    testGain.connect(this.audioContext.destination);
                    
                    // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³
                    testGain.gain.setValueAtTime(0, this.audioContext.currentTime);
                    testGain.gain.linearRampToValueAtTime(0.3, this.audioContext.currentTime + 0.1);
                    
                    // é–‹å§‹
                    testOsc.start();
                    
                    // 1ç§’å¾Œã«åœæ­¢
                    setTimeout(() => {
                        testGain.gain.linearRampToValueAtTime(0, this.audioContext.currentTime + 0.1);
                        setTimeout(() => {
                            testOsc.stop();
                        }, 100);
                    }, 1000);
                    
                    console.log('éŸ³å£°ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...');
                    
                } catch (error) {
                    console.error('éŸ³å£°ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                    alert('éŸ³å£°ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ' + error.message);
                }
            }
        }

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            const app = new TiltHarmonica();
            
            // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½
            const navMain = document.getElementById('nav-main');
            const navTest = document.getElementById('nav-test');
            const mainContent = document.querySelector('.container');
            const testContent = document.getElementById('test-content');
            
            navMain.addEventListener('click', () => {
                navMain.classList.add('active');
                navTest.classList.remove('active');
                mainContent.style.display = 'block';
                testContent.style.display = 'none';
            });
            
            navTest.addEventListener('click', () => {
                navTest.classList.add('active');
                navMain.classList.remove('active');
                testContent.style.display = 'block';
                mainContent.style.display = 'none';
            });
            
            // é–‹å§‹ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
            const startButton = document.getElementById('start-button');
            startButton.addEventListener('click', () => {
                if (!app.isInitialized) {
                    alert('ã‚¢ãƒ—ãƒªã®åˆæœŸåŒ–ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                
                if (app.isPlaying) {
                    app.stopAudio();
                } else {
                    app.startAudio();
                }
            });
            
            // éŸ³å£°ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
            const testSoundButton = document.getElementById('test-sound-button');
            testSoundButton.addEventListener('click', () => {
                if (!app.isInitialized) {
                    alert('ã‚¢ãƒ—ãƒªã®åˆæœŸåŒ–ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                app.testSound();
            });
            
            // ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
            const permissionButton = document.getElementById('permission-button');
            permissionButton.addEventListener('click', () => {
                if (!app.isInitialized) {
                    alert('ã‚¢ãƒ—ãƒªã®åˆæœŸåŒ–ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                app.checkSensorPermission();
            });
            
            // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            window.addEventListener('beforeunload', () => {
                if (app.isPlaying) {
                    app.stopAudio();
                }
            });
            
            // ãƒšãƒ¼ã‚¸éè¡¨ç¤ºæ™‚ã®éŸ³å£°åœæ­¢
            document.addEventListener('visibilitychange', () => {
                if (document.hidden && app.isPlaying) {
                    app.stopAudio();
                }
            });
        });

        // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šPCã§ã®ãƒ†ã‚¹ãƒˆç”¨
        if (!window.DeviceOrientationEvent) {
            console.log('ãƒ‡ãƒã‚¤ã‚¹ã‚»ãƒ³ã‚µãƒ¼ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒã‚¤ã‚¹ã§ãŠè©¦ã—ãã ã•ã„ã€‚');
            
            // PCã§ã®ãƒ†ã‚¹ãƒˆç”¨ï¼ˆãƒã‚¦ã‚¹ç§»å‹•ã§ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆï¼‰
            let isMouseSimulating = false;
            
            document.addEventListener('click', () => {
                if (!isMouseSimulating) {
                    isMouseSimulating = true;
                    console.log('ãƒã‚¦ã‚¹ç§»å‹•ã§ã‚»ãƒ³ã‚µãƒ¼å€¤ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã—ã¾ã™ï¼ˆPCãƒ†ã‚¹ãƒˆç”¨ï¼‰');
                }
            });
            
            document.addEventListener('mousemove', (e) => {
                if (isMouseSimulating) {
                    // ãƒã‚¦ã‚¹ä½ç½®ã‚’ã‚»ãƒ³ã‚µãƒ¼å€¤ã«å¤‰æ›
                    const gamma = (e.clientX / window.innerWidth) * 90 - 45;
                    const beta = (e.clientY / window.innerHeight) * 60 - 30;
                    
                    // ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
                    const event = new Event('deviceorientation');
                    event.gamma = gamma;
                    event.beta = beta;
                    
                    window.dispatchEvent(event);
                }
            });
        }
    </script>
</body>
</html> 